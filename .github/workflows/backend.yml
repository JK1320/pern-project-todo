name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    defaults: 
      run:
        working-directory: server

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Install SSH client
      run: sudo apt-get install -y openssh-client

    - name: SSH into EC2 instance
      run: |
        scp -o StrictHostKeyChecking=no -i ${{ secrets.SERVER_SSH_KEY }} \
          --exclude 'node_modules' --exclude '.git' --exclude 'database.sql' \
          ./Documents/GitHub/pern-project-todo/server/* ec2-user@ec2-18-133-247-174.eu-west-2.compute.amazonaws.com:/home/ubuntu/app
        ssh -o StrictHostKeyChecking=no -i ${{ secrets.SERVER_SSH_KEY }} ec2-user@your-ec2-public-ip "\
          cd /home/ubuntu/app && \
          git pull origin main && \
          sudo systemctl restart your-backend-service"
      
